INSERT INTO jp2_int.ITMD_4_S_SORG_SLS_WRKR_BP_PRD_TIME_BCKT_SRVY_FOL_UP
SELECT DISTINCT 
ALIGT.sorg_unit_sk 						AS SORG_UNIT_SK,
SMRY.BP_PAR_SK 							AS BP_PAR_SK,  
SMRY.BP_SK								AS BP_SK, 
SMRY.PSET_SK							AS PSET_SK,	
SMRY.PRD_GRP_SK							AS PRD_GRP_SK,	
SMRY.PAT_BRD_INATN_CALD_DT_SK 			AS PAT_BRD_INATN_CALD_DT_SK, 
SMRY.SRC_CREA_DT_SK			        	AS SRC_CREA_DT_SK,			
SMRY.FOL_UP_CALD_DT_SK       	    	AS FOL_UP_CALD_DT_SK,       	
SMRY.TRTT_STRT_CALD_DT_SK    	    	AS TRTT_STRT_CALD_DT_SK,    	
SMRY.TRTT_END_CALD_DT_SK     	    	AS TRTT_END_CALD_DT_SK,     	
SMRY.PLAN_DEVY_CALD_DT_SK    	    	AS PLAN_DEVY_CALD_DT_SK,    	
SMRY.BP_PRD_RX_ID                   	AS BP_PRD_RX_ID,  
aligt.bu_cd 							As bus_unit_cd,				
aligt.regn_cd	 						AS regn_cd,  
aligt.DST_CD	 						AS DST_CD, 
aligt.terr_cd 							AS TERR_CD,          
DSW_terr.bms_id							AS sls_wrkr_cd,
aligt.terr_seq_num  					as  SLS_WRKR_DUAL_FLAG, 
BP.BP_CD 								AS INSN_CD ,
ULT.bp_extl_idnty_val_txt  				AS INSN_DCF_DSF_CD,
BP.bp_sls_chnl_ds 						AS INSN_SLS_CHNL_CD, 
SEG.segn_cd 							AS INSN_TIER_CD,
DR_SEG.SEGN_CD 							AS DR_SEG_CD,
DR.bp_extl_idnty_val_txt 				AS dr_dcf_cd ,
SMRY.RF_CD                          	AS RF_CD,
null 		 							AS bus_unit_nm,				
null 									AS REGN_NM,  
null 									AS  dst_nm, 
null 									AS Terr_nm, 
aligt.bu_lcl_nm	 						AS bus_unit_lcl_nm,				
aligt.regn_lcl_nm	 					AS REGN_lcl_NM,  
aligt.dst_lcl_nm						AS dst_lcl_nm, 
aligt.terr_lcl_nm 						AS terr_lcl_nm, 
DSW_terr.lcl_wrkr_last_nm||'ã€€'||DSW_terr.lcl_wrkr_frst_nm AS SLS_WRKR_NM,
DP.PRD_SHRT_DS 							AS prd_nm,
DP2.PRD_SHRT_DS 						AS prd_grp_nm,
BP.BP_NM 								AS INSN_NM,
case when TRGT.TRGT_IND IN ('Co-Visit BMS','Co-Visit Co-Pro') THEN 'Co-Visit' ELSE TRGT.TRGT_IND END AS INSN_TRGT_TYPE_NM,
DR.BP_NM 								AS DR_NM,
SMRY.STG_OF_DIS_NM            			AS STG_OF_DIS_NM,            	
SMRY.AGE_TXT                  	        AS AGE_TXT    ,              	
SMRY.AMT_OF_DEVY_DSG_TXT			    AS AMT_OF_DEVY_DSG_TXT,		
SMRY.CMBN_MEDC_TXT						AS CMBN_MEDC_TXT,
SMRY.CMPLCTNS_TXT						AS CMPLCTNS_TXT,	
SMRY.EFCT_1ST_LN_TXT 				    AS EFCT_1ST_LN_TXT, 				
SMRY.EFCT_2ND_LN_TXT 				    AS EFCT_2ND_LN_TXT, 				
SMRY.EFCT_3RD_LN_TXT 				    AS EFCT_3RD_LN_TXT, 				
SMRY.EFCT_4TH_LN_TXT 				    AS EFCT_4TH_LN_TXT, 				
SMRY.GNDR_TXT                 	        AS GNDR_TXT,  
SMRY.HSTGY_TXT							AS HSTGY_TXT,
SMRY.PD_L1_STA_TXT						AS PD_L1_STA_TXT,               	
SMRY.HCP_INTENTION_TXT			        AS HCP_INTENTION_TXT,			
SMRY.HIGH_RISK_CHROMOSOME_ABNORMALITY_TXT     AS HIGH_RISK_CHROMOSOME_ABNORMALITY_TXT, 
SMRY.msi_test_time_txt as msi_test_time_txt,
SMRY.MTX_WKLY_RX_CMB_USE_TXT  	        AS MTX_WKLY_RX_CMB_USE_TXT,  	
SMRY.PAT_STA_CMPLCTN_TXT      	        AS PAT_STA_CMPLCTN_TXT,      	
SMRY.PAT_CNF_TXT 					    AS PAT_CNF_TXT, 				
SMRY.PERD_1ST_LN_TXT 				    AS PERD_1ST_LN_TXT, 				
SMRY.PERD_2ND_LN_TXT 				    AS PERD_2ND_LN_TXT, 				
SMRY.PERD_3RD_LN_TXT 				    AS PERD_3RD_LN_TXT, 				
SMRY.PERD_4TH_LN_TXT 				    AS PERD_4TH_LN_TXT, 
SMRY.PREV_DIS_TXT						AS PREV_DIS_TXT,	
SMRY.PREV_TRTT_REGM_TXT					AS PREV_TRTT_REGM_TXT,		
SMRY.PS_TXT                             AS PS_TXT,	
SMRY.REGM_1ST_LN_TXT 				    AS REGM_1ST_LN_TXT, 				
SMRY.REGM_2ND_LN_TXT 				    AS REGM_2ND_LN_TXT, 				
SMRY.REGM_3RD_LN_TXT 				    AS REGM_3RD_LN_TXT, 				
SMRY.REGM_4TH_LN_TXT 				    AS REGM_4TH_LN_TXT,
SMRY.rlps_type_txt 						AS rlps_type_txt, 				
SMRY.RX_LN_TXT                	        AS RX_LN_TXT, 
SMRY.spctby_txt							AS spctby_txt,
SMRY.SNTVY_POMALIDOMIDE_TXT 			AS SNTVY_POMALIDOMIDE_TXT,
SMRY.THER_AREA_TXT 						AS THER_AREA_TXT,
SMRY.trtt_expc_prd_txt					AS trtt_expc_prd_txt,
SMRY.TRTT_HIST_POMALIDOMIDE_TXT			AS TRTT_HIST_POMALIDOMIDE_TXT,            	
SMRY.TRTT_LN_TXT               	        AS TRTT_LN_TXT,               	
SMRY.ACPA_DSG_DS              	        AS ACPA_DSG_DS,              	
SMRY.BIO_MLCL_USE_DS          	        AS BIO_MLCL_USE_DS,          	
SMRY.DIAGS_DS	  	 			        AS DIAGS_DS	,  	 			
SMRY.TRTT_TERMN_REAS_DS  		        AS TRTT_TERMN_REAS_DS , 		
SMRY.WT_NUM                   	        AS WT_NUM ,                  	
SMRY.DIS_DUR_CT               	        AS DIS_DUR_CT ,              	
SMRY.MTX_WKLY_RX_DOSE_CT      	        AS MTX_WKLY_RX_DOSE_CT,      	   
CASE WHEN TRGTDR.bp_par_sk is not null then 1 else 0 end as TRGT_FLAG, 
SMRY.LAST_MODF_TS                   AS LAST_MODF_TS
FROM jp2_int.ITMD_3_S_SORG_SLS_WRKR_BP_PRD_TIME_BCKT_SRVY_FOL_UP SMRY
INNER JOIN  jp2_int.itmd_3_s_sorg_sls_wrkr_bp_prd_time_bckt_srvy aligt on smry.bp_par_sk=aligt.bp_sk and smry.pset_sk=aligt.pset_Sk 

lEFT OUTER JOIN JP2A_CDW.xref_rpt_trgt_dr TRGTDR ON SMRY.bp_par_sk=TRGTDR.bp_par_sk  AND SMRY.bp_sk=TRGTDR.bp_sk AND SMRY.pset_sk=TRGTDR.PSET_SK  AND TRGTDR.STRT_CALD_DT_SK IN ( SELECT max_strt_dt_cald_sk FROM JP_OPS.cntl_refh_max_cycl_plan)
/*This is to get the target institution type and its display name*/
LEFT OUTER JOIN (Select distinct bp_sk, pset_sk,src_trgt_cd as  trgt_ind  from jp3a_cdw.dg_insn_prd_trgt where src_trgt_cd is not null  ) TRGT ON smry.bp_par_sk=TRGT.BP_SK AND smry.pset_sk=TRGT.PSET_SK 
/*This is to get the target tier type and its display name*/
LEFT OUTER JOIN jp3a_cdw.dg_insn_prd_trgt_tier bpt on smry.bp_par_sk=bpt.bp_sk and smry.pset_Sk=bpt.pset_sk  and bpt.src_trgt_type_ds='TIER' 
and (TO_CHAR(bpt.src_strt_dt,'YYYYMMDD')::int) <= ( SELECT max_strt_dt_cald_sk FROM JP_OPS.cntl_refh_max_cycl_plan) and  (TO_CHAR(bpt.src_end_dt,'YYYYMMDD')::int) > ( SELECT max_strt_dt_cald_sk FROM JP_OPS.cntl_refh_max_cycl_plan)
LEFT OUTER JOIN JP2A_CDW.d_segn SEG ON SEG.segn_sk=BPT.SEGN_SK  AND SEG.SEGN_TYPE_dS='TIER'

/* This is to get the institution related information */
LEFT OUTER JOIN (
SELECT BP_SK, BP_NM, BP_CD, bp_sls_chnl_ds FROM JP2A_CDW.D_BP  WHERE BP_TYPE_NM = 'ORGANIZATION' ) BP ON SMRY.BP_PAR_SK=BP.BP_SK
left  JOIN jp2a_cdw.d_bp_extl_idnty ULT ON BP.BP_SK=ULT.BP_SK and bp_extl_idnty_type_nm='ULTMARC ID'
 /* This is to get the Doctor related information */
LEFT OUTER JOIN ( SELECT distinct  a.bp_sk,a.bp_nm ,  r.bp_extl_idnty_id, r.bp_extl_idnty_val_txt FROM   jp2a_cdw.d_bp a
inner join jp2a_cdw.d_bp_extl_idnty r on  a.bp_sk= r.bp_sk WHERE  a.bp_type_cd = 'INDV' and  bp_extl_idnty_type_nm='ULTMARC ID' ) DR ON DR.BP_SK=SMRY.BP_SK 
/* This is to get the doctor segment code*/
lEFT OUTER JOIN ( SELECT pset_sk, bp_sk, par_bp_sk as bp_par_Sk, segn_cd from jp3a_Cdw.dg_insn_bp_prd_seg seg
LEFT OUTER JOIN JP2A_CDW.d_segn DSEG ON SEG.SEGN_SK=DSEG.SEGN_SK AND SEGN_TYPE_DS='Doctor Rating') DR_SEG ON DR_SEG.BP_PAR_SK=SMRY.BP_PAR_SK AND DR_SEG.BP_SK=SMRY.BP_SK AND DR_SEG.PSET_sK=SMRY.PSET_sK
LEFT OUTER JOIN JP2A_CDW.D_PSET DP ON DP.PSET_SK = SMRY.PSET_SK 
LEFT OUTER JOIN JP2A_CDW.D_PSET DP2 ON DP2.PSET_SK = SMRY.PRD_GRP_SK 
/* This is to get the sales worker related attribute information */
LEFT OUTER JOIN JP2A_CDW.d_sls_wrkr DSW_terr ON DSW_terr.SLS_WRKR_SK=aligt.SRC_SORG_SLS_WRKR_SK;